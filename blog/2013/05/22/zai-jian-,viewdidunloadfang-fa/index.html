
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>再见，viewDidUnload方法 - 11IT</title>
  <meta name="author" content="Jacky">

  
  <meta name="description" content="前言 我在去年的一篇文章《iOS5中UIViewController的新方法》中介绍了iOS5引入的关于ViewController的新方法。但是现在如果运行该文章中的Sample代码的话，你会发现Log中不会再出现viewDidUnload方法被调用的记录。这是因为在iOS6中， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.11it.com/blog/2013/05/22/zai-jian-%2Cviewdidunloadfang-fa">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="11IT" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-19318220-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">11IT</a></h1>
  
    <h2>All about IT.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.11it.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">主页</a></li>
  <li><a href="/blog/archives">存档</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">再见，viewDidUnload方法</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-22T15:59:00+08:00" pubdate data-updated="true">2013年05月22日 15:59</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h3>前言</h3>

<p>我在去年的一篇文章《iOS5中UIViewController的新方法》中介绍了iOS5引入的关于ViewController的新方法。但是现在如果运行该文章中的Sample代码的话，你会发现Log中不会再出现viewDidUnload方法被调用的记录。这是因为在iOS6中，viewDidUnload回调方法被Deprecated掉了。查看苹果的文档，可以看到如下的说明。</p>

<!-- more -->


<p><img src="http://ww1.sinaimg.cn/large/70e1c5f8gw1e4x4y97jccj20h1051aaa.jpg" alt="image" /></p>

<p>那么，原本在viewDidUnload中的代码应该怎么处理？在iOS6中，又应该怎么处理内存警告？带着这些问题，我查找了一些资料，在此分享给大家。</p>

<h3>分析</h3>

<p>在iOS4和iOS5系统中，当内存不足，应用收到Memory warning时，系统会自动调用当前没在界面上的ViewController的viewDidUnload方法。 通常情况下，这些未显示在界面上的ViewController是UINavigationController Push栈中未在栈顶的ViewController，以及UITabBarViewController中未显示的子ViewController。这些View Controller都会在Memory Warning事件发生时，被系统自动调用viewDidUnload方法。</p>

<p>在iOS6中，由于viewDidUnload事件在iOS6下任何情况都不会被触发，所以苹果在文档中建议，应该将回收内存的相关操作移到另一个回调函数：didReceiveMemoryWarning 中。但是如果你仅仅是把以前写到viewDidUnload函数中的代码移动到didReceiveMemoryWarning函数中，那么你就错了。以下是一个 错误的示例代码 ：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)didReceiveMemoryWarning {
</span><span class='line'>    [super didReceiveMemoryWarning];
</span><span class='line'>    if([self isViewLoaded] && ![[self view] window]) {
</span><span class='line'>        [self setView:nil];
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ol>
<li>UIView有一个CALayer的成员变量，CALayer是具体用于将自己画到屏幕上的。如下图所示：</li>
</ol>


<p><img src="http://ww1.sinaimg.cn/large/70e1c5f8gw1e4x52sbj5dj20hb06mjrs.jpg" alt="image" /></p>

<ol>
<li><p>CALayer是一个bitmap图象的容器类，当UIView调用自身的drawRect时，CALayer才会创建这个bitmap图象类。</p></li>
<li><p>具体占内存的其实是一个bitmap图象类，CALayer只占48bytes, UIView只占96bytes。而一个iPad的全屏UIView的bitmap类会占到12M的大小！</p></li>
<li><p>在iOS6时，当系统发出MemoryWarning时，系统会自动回收bitmap类。但是不回收UIView和CALayer类。这样即回收了大部分内存，又能在需要bitmap类时，通过调用UIView的drawRect: 方法重建。</p></li>
</ol>


<h3>内存优化</h3>

<p>另外文章中还提到苹果的操作系统对此做的一个内存优化技巧，解释如下：</p>

<ol>
<li><p>当一段内存被分配时，它会被标记成“In use“, 以防止被重复使用。当内存被释放时，这段内存会被标记成”Not in use”，这样，在有新的内存申请时，这块内存就可能被分配给其它变量。</p></li>
<li><p>CALayer包括的具体的bitmap内容的私有成员变量类型为CABackingStore， 当收到MemroyWarning时， CABackingStore类型的内存区会被标记成volatile类型（这里的volatile和 C以及Java语言的volatile不是一个意思），volatile表示，这块内存可能被再次被原变量重用。</p></li>
</ol>


<p>这样，有了上面的优化后，当收到Memoy Warning时，虽然所有的CALayer所包含的bitmap内存都被标记成volatile了，但是只要这块内存没有再次被复用，那么当需要重建bitmap内存时， 它就可以直接被复用，而避免了再次调用 UIView的 drawRect: 方法。</p>

<h3>总结</h3>

<p>所以，简单来说，对于iOS6，你不需要做任何以前viewDidUnload的事情，更不需要把以前viewDidUnload的代码移动到 didReceiveMemoryWarning方法中。</p>

<blockquote>
引用WWDC 2012 中的一段话来给viewDidUnload说再见：

The method viewWillUnload and viewDidUnload. We’re not going to call them anymore. I mean, there’s kind of a cost-benifit equation and analysis that we went through. In the early days, there was a real performance need for us to ensure that on memory warnings we unloaded views. There was all kinds of graphics and backing stores and so forth that would also get unloaded. We now unload those independently of the view, so it isn’t that big of a deal for us for those to be unloaded, and there were so many bugs where there would be pointers into。
</blockquote>


<h3>参考链接</h3>

<p>View Controller Lifecycle in iOS 6
CALayer Internals: Contents</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jacky</span></span>

      








  


<time datetime="2013-05-22T15:59:00+08:00" pubdate data-updated="true">2013年05月22日 15:59</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ioskai-fa/'>iOS开发</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/05/22/objective-cde-xin-te-xing/" title="Previous Post: Objective-C的新特性">&laquo; Objective-C的新特性</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/instagram/'>Instagram (1)</a></li>
<li class='category'><a href='/blog/categories/linux/'>Linux (1)</a></li>
<li class='category'><a href='/blog/categories/ios开发/'>iOS开发 (2)</a></li>
<li class='category'><a href='/blog/categories/移动互联网/'>移动互联网 (1)</a></li>

  </ul>
</section><section>
  <h1>Recent Comments</h1>
  <div id="dsq-recentcomments" class="dsq-widget"><script type="text/javascript" src="http://disqus.com/forums/11it/recent_comments_widget.js?hide_avatars=1"></script></div>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/05/22/zai-jian-%2Cviewdidunloadfang-fa/">再见，viewDidUnload方法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/22/objective-cde-xin-te-xing/">Objective-C的新特性</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/22/ru-he-rang-instagram-zai-%5B%3F%5D-bai-duo-mo-yong-hu-bao-zha-hou-wen-ding-yun-xing/">如何让 Instagram 在一百多万用户爆炸后稳定运行</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/22/arch%2Czai-jian/">Arch，再见</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/22/ping-lun-%3Aios-ping-tai-shi-xin-shi-qi-de-windows-ping-tai/">评论：iOS 平台是新时期的 Windows 平台</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/22/wei-ruan-tui-chu-zheng-shi-fa-bu-xbox-one%3Aqiang-diao-yu-yin-he-shou-shi-kong-zhi/">微软推出正式发布Xbox One：强调语音和手势控制</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/22/dai-kuan-fen-qi-mai-iphone-da-hu-you-nian-li-lu-jing-chao-45-percent/">“贷款分期买iPhone”大忽悠 年利率竟超45%</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/22/xiao-xi-cheng-gu-ge-yuan-sheng-ban-galaxy-s4jin-zai-mei-guo-fa-xing/">消息称谷歌原生版Galaxy S4仅在美国发行</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/22/ce-shi-fa-bu/">测试发布</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/22/xin-wen-zhang-ming-cheng/">新文章名称</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>广告</h1>
  <script type="text/javascript">
       document.write('<a style="display:none!important" id="tanx-a-mm_21701886_4042037_13136621"></a>');
       tanx_s = document.createElement("script");
       tanx_s.type = "text/javascript";
       tanx_s.charset = "gbk";
       tanx_s.id = "tanx-s-mm_21701886_4042037_13136621";
       tanx_s.async = true;
       tanx_s.src = "http://p.tanx.com/ex?i=mm_21701886_4042037_13136621";
       tanx_h = document.getElementsByTagName("head")[0];
       if(tanx_h)tanx_h.insertBefore(tanx_s,tanx_h.firstChild);
  </script>
  
  <script type="text/javascript">
  (function(win,doc){
  var s = doc.createElement("script"), h = doc.getElementsByTagName("head")[0];
  if (!win.alimamatk_show) {
  s.charset = "gbk";
  s.async = true;
  s.src = "http://a.alimama.cn/tkapi.js";
  h.insertBefore(s, h.firstChild);
  }
  var o = {
  pid: "mm_21701886_4042037_13142461",
  appkey: "",
  unid: ""
  }
  win.alimamatk_onload = win.alimamatk_onload || [];
  win.alimamatk_onload.push(o);
  })(window,document);
  </script>
  
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Jacky -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = '11it';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.11it.com/blog/2013/05/22/zai-jian-%2Cviewdidunloadfang-fa/';
        var disqus_url = 'http://www.11it.com/blog/2013/05/22/zai-jian-%2Cviewdidunloadfang-fa/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
